{% load static %}
{# Donations Tab Content #}
<div class="tab-panel" id="donations">
  <div class="tab-header">
    <h2>Donations</h2>
    <p>Track and manage donations received for your church posts</p>
  </div>
  <div class="tab-content">
    <!-- 1x4 Analytics Cards Grid -->
    <div class="analytics-grid-4">
      <div class="analytics-card">
        <div class="analytics-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
        </div>
        <div class="analytics-content">
          <h4>â‚±{{ donations.this_month_amount|floatformat:2|default:"0.00" }}</h4>
          <p>This Month</p>
          <span class="analytics-change">{{ donations.this_month_count }} donations</span>
        </div>
      </div>
      
      <div class="analytics-card">
        <div class="analytics-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
          </svg>
        </div>
        <div class="analytics-content">
          <h4>â‚±{{ donations.this_year_amount|floatformat:2|default:"0.00" }}</h4>
          <p>This Year</p>
          <span class="analytics-change">{{ donations.this_year_count }} donations</span>
        </div>
      </div>
      
      <div class="analytics-card">
        <div class="analytics-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
        </div>
        <div class="analytics-content">
          <h4>{{ donations.unique_donors|default:"0" }}</h4>
          <p>Unique Donors</p>
          <span class="analytics-change">{{ donations.total_donations }} total donations</span>
        </div>
      </div>
      
      <div class="analytics-card">
        <div class="analytics-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>
        </div>
        <div class="analytics-content">
          <h4>â‚±{{ donations.total_amount|floatformat:2|default:"0.00" }}</h4>
          <p>Total Received</p>
          <span class="analytics-change">All time donations</span>
        </div>
      </div>
    </div>

    <!-- 1x2 Charts Grid -->
    <div class="charts-grid-2">
      {# Monthly Donation Trends Chart #}
      <div class="chart-container">
        <div class="chart-header">
          <h4>Donation Trends</h4>
          <p>Monthly donation totals and donor count</p>
        </div>
        <div class="chart-content">
          <canvas id="donationTrendsChart" 
                  width="400" 
                  height="250"
                  data-monthly-amounts="{{ donations.monthly_amounts|default:'[]' }}"
                  data-monthly-donors="{{ donations.monthly_donors|default:'[]' }}"></canvas>
          
          {# Chart Summary Stats #}
          <div class="chart-summary-stats">
            <div class="summary-stat-item">
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"/>
                  <polyline points="19 12 12 19 5 12"/>
                </svg>
              </div>
              <div class="stat-info">
                <span class="stat-label">Avg. Monthly</span>
                <span class="stat-value">â‚±{{ donations.average_monthly|floatformat:2|default:"0.00" }}</span>
              </div>
            </div>
            <div class="summary-stat-item">
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
              </div>
              <div class="stat-info">
                <span class="stat-label">Highest Month</span>
                <span class="stat-value">â‚±{{ donations.highest_month|floatformat:2|default:"0.00" }}</span>
              </div>
            </div>
            <div class="summary-stat-item">
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                  <polyline points="17 6 23 6 23 12"/>
                </svg>
              </div>
              <div class="stat-info">
                <span class="stat-label">Growth Rate</span>
                <span class="stat-value {% if donations.growth_rate > 0 %}positive{% elif donations.growth_rate < 0 %}negative{% endif %}">
                  {{ donations.growth_rate|default:"0" }}%
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      {# Top 3 Donors Chart #}
      <div class="chart-container">
        <div class="chart-header">
          <h4>Top 3 Donors</h4>
          <p>Ranking by total donated amount</p>
        </div>
        <div class="chart-content">
          <canvas id="topDonorsChart" width="400" height="250"></canvas>
          <div class="posts-ranking donor-ranking">
            {% for donor in donations.top_donors|slice:":3" %}
            <div class="ranking-item" data-rank="{{ forloop.counter }}" data-engagement="{{ donor.total_donated|default:'0' }}" data-max-engagement="{{ donations.top_donors.0.total_donated|default:'1' }}">
              <div class="rank-number">{{ forloop.counter }}</div>
              <div class="post-info">
                <p>
                  {% if donor.profile and donor.profile.display_name %}
                    {{ donor.profile.display_name }}
                  {% elif donor.first_name or donor.last_name %}
                    {{ donor.get_full_name }}
                  {% else %}
                    {{ donor.username }}
                  {% endif %}
                </p>
                <div class="engagement-total">â‚±{{ donor.total_donated|floatformat:2 }} donated</div>
              </div>
              <div class="engagement-bar">
                <div class="bar-fill"></div>
              </div>
            </div>
            {% empty %}
            <div class="no-posts">
              <p>No donors available for ranking</p>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Donations Section -->
    <div class="content-section">
      <div class="section-header">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 16px;">
          <div>
            <h3>Recent Donations</h3>
            <p>Transaction history and donor information</p>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div class="donations-search-wrapper" style="display: flex; align-items: center;">
              <input 
                type="text" 
                id="donations-search-input" 
                placeholder="Search by Donor Name or Post" 
                style="max-width: 260px; width: 100%; padding: 8px 12px; border-radius: 999px; border: 1px solid #d1d5db; font-size: 0.875rem;"
              />
            </div>
            <a href="{% url 'core:export_church_donations_excel' church.id %}" 
               class="btn btn-primary" 
               style="display: inline-flex; align-items: center; justify-content: center; padding: 8px; background: #16a34a; color: #ffffff; text-decoration: none; border-radius: 6px; border: none; box-shadow: 0 2px 4px rgba(22, 163, 74, 0.35); transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;"
               onmouseover="this.style.background='#15803d'; this.style.boxShadow='0 3px 6px rgba(22, 163, 74, 0.45)'; this.style.transform='translateY(-1px)'"
               onmouseout="this.style.background='#16a34a'; this.style.boxShadow='0 2px 4px rgba(22, 163, 74, 0.35)'; this.style.transform='translateY(0)'"
               title="Export to Excel">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                <path d="M8,12V14H16V12H8M8,16V18H13V16H8Z" fill="currentColor"/>
                <path d="M16,10L12,6L16,10Z" fill="currentColor"/>
              </svg>
            </a>
          </div>
        </div>
      </div>

      {% if donations.recent_donations %}
        <div class="donations-table-wrapper">
          <table class="donations-table">
            <thead>
              <tr>
                <th class="sortable" data-sort-key="donor">Donor</th>
                <th class="sortable" data-sort-key="amount">Amount</th>
                <th class="sortable" data-sort-key="type">Type</th>
                <th class="sortable" data-sort-key="method">Method</th>
                <th class="sortable" data-sort-key="post">Post</th>
                <th class="sortable" data-sort-key="date">Date</th>
                <th class="sortable" data-sort-key="status">Status</th>
              </tr>
            </thead>
            <tbody>
              {% for donation in donations.recent_donations %}
              <tr class="donation-row">
                <td class="donation-donor">
                  <div class="donor-cell">
                    <div class="donor-avatar-small">
                      {% if donation.is_anonymous %}
                        <div class="avatar-initials">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                          </svg>
                        </div>
                      {% else %}
                        {% if donation.donor.profile and donation.donor.profile.profile_image %}
                          <img src="{{ donation.donor.profile.profile_image.url }}" alt="{{ donation.get_donor_name }}" class="donor-profile-img">
                        {% else %}
                          <div class="avatar-initials">
                            {{ donation.donor.first_name|first|default:"U"|upper }}{{ donation.donor.last_name|first|default:""|upper }}
                          </div>
                        {% endif %}
                      {% endif %}
                    </div>
                    <div class="donor-info-cell">
                      <div class="donor-name-cell">
                        {% if donation.is_anonymous %}
                          <span class="anonymous-donor">Anonymous</span>
                        {% else %}
                          {{ donation.get_donor_name }}
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </td>
                <td class="donation-amount">
                  <span class="amount-cell">â‚±{{ donation.amount|floatformat:2 }}</span>
                </td>
                <td class="donation-type">
                  <span class="badge badge-{{ donation.donation_type|default:'one-time' }}">
                    {% if donation.donation_type == 'monthly' %}Monthly{% else %}One-time{% endif %}
                  </span>
                </td>
                <td class="donation-method">
                  {% if donation.payment_method == 'stripe' %}
                  <span class="method-badge method-stripe">
                    <svg class="card-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                      <line x1="1" y1="10" x2="23" y2="10"/>
                    </svg>
                    Credit Card
                  </span>
                  {% else %}
                  <span class="method-badge method-paypal">
                    <svg class="paypal-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M20.067 8.478c.492.88.556 2.014.3 3.327-.74 3.806-3.276 5.12-6.514 5.12h-.5a.805.805 0 0 0-.794.68l-.04.22-.63 3.993-.032.17a.804.804 0 0 1-.794.679H7.72a.483.483 0 0 1-.477-.558L7.418 20h1.518l.95-6.02h1.385c4.678 0 7.75-2.203 8.796-6.502z" fill="#009cde"/>
                    </svg>
                    PayPal
                  </span>
                  {% endif %}
                </td>
                <td class="donation-post">
                  <span class="post-cell" title="{{ donation.post.content|striptags }}">
                    {{ donation.post.content|striptags|truncatechars:30 }}
                  </span>
                </td>
                <td class="donation-date">
                  <span class="date-cell">{{ donation.created_at|date:"Y-m-d" }}</span>
                </td>
                <td class="donation-status">
                  <span class="status-badge status-{{ donation.payment_status }}">
                    {{ donation.get_payment_status_display }}
                  </span>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        {% if donations.total_donations > 20 %}
          <div class="table-pagination">
            <button class="btn btn-outline" onclick="loadMoreDonations()">
              Load More Donations
            </button>
          </div>
        {% endif %}
      {% else %}
        <div class="empty-state">
          <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>
          <h4>No donations yet</h4>
          <p>Donations will appear here when people donate to your church posts.</p>
          <div class="empty-actions">
            <p class="tip">ðŸ’¡ <strong>Tip:</strong> Enable donations on your posts to start receiving support from your community.</p>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>
