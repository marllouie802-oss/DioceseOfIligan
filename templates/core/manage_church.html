{% extends 'layouts/app_base.html' %}
{% load static %}

{% block title %}Manage Church - ChurchConnect{% endblock %}

{% block body_class %}page-manage-church{% endblock %}

{% block extra_css %}
  <!-- Blue Sky Theme -->
  <link rel="stylesheet" href="{% static 'css/variables/blue-sky-vars.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/themes/blue-sky-theme.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/buttons.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/cards.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/forms.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/post_analytics_modal.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/post_creation_modal.css' %}?v={{ STATIC_VERSION }}">
  <!-- Page-specific styles -->
  <link rel="stylesheet" href="{% static 'css/pages/manage-church.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/create_booking_manual.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css">
{% endblock %}

{% block sidebar %}
  {% include 'partials/sidebar.html' %}
{% endblock %}
{% block topbar %}
  {% include 'partials/topbar.html' %}
{% endblock %}

{% block content %}
{# Church Management Page #}
<div class="manage-church-page blue-sky page-container" data-church-id="{{ church.id }}">
  {# Page Header #}
  {% include 'partials/manage/page_header.html' %}
  
  {# Verification Status Banner #}
  {% include 'partials/manage/verification_banner.html' with church=church latest_verification=latest_verification %}
  
  {# Church Preview Section #}
  {% include 'partials/manage/church_preview.html' with church=church %}
  
  {# Main Management Interface #}
  <div class="management-tabs">
    <div class="tabs-container">
      {# Tab Navigation #}
      {% include 'partials/manage/tab_navigation.html' %}
      
      <div class="tabs-content">
        {# Overview Tab #}
        {% include 'partials/manage/overview_tab.html' with church=church follower_count=follower_count analytics=analytics bookings=bookings booking_counts=booking_counts donations=donations %}

        {# Appointments Tab #}
        {% include 'partials/manage/appointments_tab.html' with bookings=bookings booking_counts=booking_counts appt_status=appt_status %}

        {# Services Tab #}
        {% include 'partials/manage/services_tab.html' with church=church %}

        {# Availability Tab #}
        {% include 'partials/manage/availability_tab.html' with church=church %}

        {# Events Tab #}
        {% include 'partials/manage/events_tab.html' with event_posts=event_posts event_posts_count=event_posts_count follower_count=follower_count church=church %}

        {# Content Tab #}
        {% include 'partials/manage/content_tab.html' with analytics=analytics follower_count=follower_count posts=posts posts_count=posts_count church=church %}

        {# Donations Tab #}
        {% include 'partials/manage/donations_tab.html' %}

        {# Transactions Tab #}
        {% include 'partials/manage/transactions_tab.html' %}

        {# Followers Tab #}
        {% include 'partials/manage/followers_tab.html' with recent_followers=recent_followers follower_count=follower_count %}

        {# Parish Admins Tab #}
        {% include 'partials/manage/admins_tab.html' with church=church %}

        {# Settings Tab #}
        {% include 'partials/manage/settings_tab.html' with church=church form=form verif_form=verif_form decline_reasons=decline_reasons %}

      </div>
    </div>
  </div>
</div>

{# Modal Dialogs #}
{% include 'partials/manage/modals.html' with church=church %}

{% endblock %}

{% block extra_js %}
{# CSRF Token for AJAX requests #}
<script>
  const csrfToken = '{{ csrf_token }}';
  window.csrfToken = '{{ csrf_token }}';
  
  // Current church ID for multi-church context
  const CURRENT_CHURCH_ID = {{ church.id }};
  window.CURRENT_CHURCH_ID = {{ church.id }};
  
  // Helper function to build URLs with church_id
  function buildChurchUrl(path, params = {}) {
    // If path already includes church_id, return as is
    if (path.includes(`/manage-church/${CURRENT_CHURCH_ID}/`)) {
      const url = new URL(path, window.location.origin);
      Object.keys(params).forEach(key => url.searchParams.set(key, params[key]));
      return url.toString();
    }
    
    // Add church_id to path
    let newPath = path;
    if (path.includes('/manage-church/') && !path.match(/\/manage-church\/\d+\//)) {
      newPath = path.replace('/manage-church/', `/manage-church/${CURRENT_CHURCH_ID}/`);
    }
    
    const url = new URL(newPath, window.location.origin);
    Object.keys(params).forEach(key => url.searchParams.set(key, params[key]));
    return url.toString();
  }
</script>
{# External Libraries #}
<script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

{# Django URL Configuration #}
  <script>
    window.djangoUrls = {
      updateChurchLogo: "{% url 'core:update_church_logo' %}",
      updateChurchCover: "{% url 'core:update_church_cover' %}",
      createAvailability: "{% url 'core:create_availability' %}?church_id={{ church.id }}&date=0",
      manageServiceImages: "{% url 'core:manage_service_images' 0 %}",
      serviceGallery: "{% url 'core:service_gallery' 0 %}",
      requestVerification: "{% url 'core:request_verification' %}",
      createDeclineReason: "{% url 'core:create_decline_reason' %}"
    };
    // Backwards compatibility for existing JS that expects globals
    window.manageServiceImagesUrl = window.djangoUrls.manageServiceImages;
    window.serviceGalleryUrl = window.djangoUrls.serviceGallery;
    // Legacy URL variable for backward compatibility
    window.createDeclineReasonUrl = "{% url 'core:create_decline_reason' %}";
  </script>

{# Core Modules #}
<script defer src="{% static 'js/core/tabs.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/core/forms.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/core/image-cropper.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/core/calendar.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/core/settings.js' %}?v={{ STATIC_VERSION }}"></script>

{# Application Modules #}
<script defer src="{% static 'js/app/manage_church_new.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/manage/post-management.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/dashboard/dashboard-posts.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/components/expandable-posts.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/components/post-view-tracker.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/components/post_analytics_modal.js' %}?v={{ STATIC_VERSION }}&t=20251031"></script>
<script defer src="{% static 'js/followers.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/sticky-tabs.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/settings-navigation.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/settings-section-edit.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/create_booking_manual.js' %}?v={{ STATIC_VERSION }}"></script>

{# Event Creation Modal JavaScript #}
<script>
// Event Creation Modal Functions
function openEventCreationModal() {
  const modal = document.getElementById('eventsCreatePostModal');
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Focus on event title field
    setTimeout(() => {
      const titleField = document.getElementById('events-event-title');
      if (titleField) titleField.focus();
    }, 100);
  }
}

function hideEventCreationModal() {
  const modal = document.getElementById('eventsCreatePostModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
    
    // Reset form
    const form = document.getElementById('eventsCreatePostForm');
    if (form) {
      form.reset();
      // Clear image previews
      const previewContainer = document.getElementById('events-images-preview');
      if (previewContainer) {
        previewContainer.innerHTML = '';
        previewContainer.style.display = 'none';
      }
      // Reset character count
      const charCount = document.getElementById('events-char-count');
      if (charCount) charCount.textContent = '0';
      // Hide donation fields
      const donationFields = document.getElementById('events-donation-fields');
      if (donationFields) donationFields.style.display = 'none';
    }
  }
}

// Handle form submission
document.addEventListener('DOMContentLoaded', function() {
  const eventsForm = document.getElementById('eventsCreatePostForm');
  if (eventsForm) {
    eventsForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('events-submit-btn');
      const submitText = submitBtn.querySelector('.submit-text');
      const submitLoading = submitBtn.querySelector('.submit-loading');
      const messageDiv = document.getElementById('events-post-creation-message');
      
      // Show loading state
      submitBtn.disabled = true;
      submitText.style.display = 'none';
      submitLoading.style.display = 'inline-flex';
      
      // Prepare form data
      const formData = new FormData(eventsForm);
      
      fetch(eventsForm.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          messageDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
          messageDiv.style.display = 'block';
          
          // Close modal after short delay
          setTimeout(() => {
            hideEventCreationModal();
            // Reload the events tab to show new event
            window.location.reload();
          }, 1500);
        } else {
          messageDiv.innerHTML = '<div class="alert alert-error">' + data.message + '</div>';
          messageDiv.style.display = 'block';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        messageDiv.innerHTML = '<div class="alert alert-error">An error occurred while creating the event.</div>';
        messageDiv.style.display = 'block';
      })
      .finally(() => {
        // Reset button state
        submitBtn.disabled = false;
        submitText.style.display = 'inline';
        submitLoading.style.display = 'none';
      });
    });
  }
  
  // Character counting for event description
  const eventsTextarea = document.getElementById('events-post-content');
  const eventsCharCount = document.getElementById('events-char-count');
  if (eventsTextarea && eventsCharCount) {
    eventsTextarea.addEventListener('input', function() {
      const count = this.value.length;
      eventsCharCount.textContent = count;
      
      if (count > 950) {
        eventsCharCount.style.color = '#e74c3c';
      } else if (count > 800) {
        eventsCharCount.style.color = '#f39c12';
      } else {
        eventsCharCount.style.color = '';
      }
    });
  }
  
  // Donation toggle functionality
  const eventsDonationToggle = document.getElementById('events-enable-donation');
  const eventsDonationFields = document.getElementById('events-donation-fields');
  if (eventsDonationToggle && eventsDonationFields) {
    eventsDonationToggle.addEventListener('change', function() {
      const hasPaypal = this.getAttribute('data-has-paypal') === 'true';
      
      if (this.checked && hasPaypal) {
        eventsDonationFields.style.display = 'block';
      } else {
        eventsDonationFields.style.display = 'none';
        if (this.checked && !hasPaypal) {
          this.checked = false;
          alert('Please set up your PayPal email in Church Settings before enabling donations.');
        }
      }
    });
  }
  
  // Image preview functionality
  const eventsImageInput = document.getElementById('events-post-images');
  const eventsPreviewContainer = document.getElementById('events-images-preview');
  if (eventsImageInput && eventsPreviewContainer) {
    eventsImageInput.addEventListener('change', function() {
      eventsPreviewContainer.innerHTML = '';
      const files = Array.from(this.files);
      
      if (files.length > 0) {
        eventsPreviewContainer.style.display = 'block';
        
        files.slice(0, 10).forEach((file, index) => {
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
              const preview = document.createElement('div');
              preview.className = 'image-preview-item';
              preview.innerHTML = `
                <img src="${e.target.result}" alt="Preview ${index + 1}">
                <button type="button" class="remove-image" onclick="removeEventImage(${index})">Ã—</button>
              `;
              eventsPreviewContainer.appendChild(preview);
            };
            reader.readAsDataURL(file);
          }
        });
      } else {
        eventsPreviewContainer.style.display = 'none';
      }
    });
  }
});

// Remove image from preview
function removeEventImage(index) {
  const input = document.getElementById('events-post-images');
  const container = document.getElementById('events-images-preview');
  
  if (input && container) {
    const dt = new DataTransfer();
    const files = Array.from(input.files);
    
    files.forEach((file, i) => {
      if (i !== index) {
        dt.items.add(file);
      }
    });
    
    input.files = dt.files;
    
    // Trigger change event to update preview
    const event = new Event('change', { bubbles: true });
    input.dispatchEvent(event);
  }
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
  const modal = document.getElementById('eventsCreatePostModal');
  if (e.target === modal) {
    hideEventCreationModal();
  }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const modal = document.getElementById('eventsCreatePostModal');
    if (modal && modal.style.display === 'flex') {
      hideEventCreationModal();
    }
  }
});
</script>
{% endblock %}
